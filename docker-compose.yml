version: '3.8'

services:
  # Service for the local Hardhat blockchain node
  hardhat-node:
    build:
      context: .
      dockerfile: Dockerfile.hardhat
    # Note: Use standard port mapping for Mac compatibility
    ports:
      - "8545:8545"
    volumes:
      - ./contracts:/app/contracts
      - ./scripts:/app/scripts
      - ./test:/app/test
      - ./hardhat.config.js:/app/hardhat.config.js
      - ./package.json:/app/package.json
      - ./package-lock.json:/app/package-lock.json
      # Note: Share artifacts directory with frontend
      - deployment-artifacts:/app/frontend/src/artifacts
    environment:
      - PRIVATE_KEY=0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80
    # IMPROVED: Better deployment script with verification
    command: |
      /bin/sh -c "
      echo '=== Starting Hardhat Node ==='
      rm -rf /app/frontend/src/artifacts
      mkdir -p /app/frontend/src/artifacts

      # Start hardhat node in background
      npx hardhat node --hostname 0.0.0.0 &
      HARDHAT_PID=\$!

      echo 'Waiting for node to start...'
      sleep 15

      # Deploy contracts
      echo '=== Deploying Contracts ==='
      npx hardhat run scripts/deploy.js --network localhost

      if [ -f /app/frontend/src/artifacts/addresses.json ]; then
        echo '=== Deployment Successful ==='
        cat /app/frontend/src/artifacts/addresses.json
      else
        echo '=== ERROR: Deployment failed - addresses.json not created ==='
        exit 1
      fi

      echo '=== Hardhat node ready for connections ==='
      wait \$HARDHAT_PID
      "
    healthcheck:
      test: |
        curl -f -X POST --data '{"jsonrpc":"2.0","method":"eth_blockNumber","params":[],"id":1}' \
        -H "Content-Type: application/json" http://localhost:8545 && \
        test -f /app/frontend/src/artifacts/addresses.json
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  # Service for the Next.js frontend
  frontend:
    build:
      context: ./frontend
      dockerfile: ../Dockerfile.frontend
    # Note: Use standard port mapping for Mac compatibility
    ports:
      - "3000:3000"
    volumes:
      - ./frontend:/app
      - /app/node_modules
      # Note: Share artifacts from hardhat
      - deployment-artifacts:/app/src/artifacts
    environment:
      # Browser connects to localhost:8545 (hardhat on host network)
      - NEXT_PUBLIC_RPC_URL=http://localhost:8545
      - NEXT_PUBLIC_CHAIN_ID=31337
    depends_on:
      hardhat-node:
        condition: service_healthy
    command: |
      /bin/sh -c "
      echo '=== Starting Frontend ==='
      ls -la /app/src/artifacts || echo 'Artifacts not yet available'

      # Wait for artifacts to be ready
      while [ ! -f /app/src/artifacts/addresses.json ]; do
        echo 'Waiting for contract deployment...'
        sleep 2
      done

      echo '=== Contracts deployed, starting Next.js ==='
      npx next dev -H 0.0.0.0 -p 3000
      "
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:3000" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s

# Named volume for artifacts sharing
volumes:
  deployment-artifacts:
